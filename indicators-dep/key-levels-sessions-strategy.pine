//@version=6
strategy("ORB + Key Levels Strategy", overlay=true, max_lines_count=500, max_boxes_count=100, max_labels_count=500,
         margin_long=5, margin_short=5, default_qty_type=strategy.fixed, default_qty_value=1,
         initial_capital=50000, currency=currency.USD,
         commission_type=strategy.commission.cash_per_contract, commission_value=0.62)

// ==================== MFF $50K ACCOUNT RULES ====================
// Profit Target: $3,000 | Max Drawdown: $2,000 EOD | Risk Per Trade: $200-400
// Max Contracts: 30 MNQ | Session: 9:30-1:30 ET | Consistency: 50% max/day

// ==================== INPUTS ====================
orbMinutes = input.int(15, "ORB Duration (minutes)", options=[5, 15, 30, 60], group="Opening Range")

// Risk Management
riskPerTrade = input.float(200.0, "Risk Per Trade ($)", minval=50, maxval=500, step=50, group="Risk Management")
stopType = input.string("Opposite ORB Level", "Stop Loss Type",
           options=["Opposite ORB Level", "Fixed Points", "ATR Based"], group="Risk Management")
fixedStopPoints = input.float(20.0, "Fixed Stop (points)", minval=5, maxval=100, group="Risk Management")
atrMultiplier = input.float(1.5, "ATR Multiplier", minval=0.5, maxval=3.0, step=0.5, group="Risk Management")

targetType = input.string("Previous Day Level", "Take Profit Type",
             options=["Previous Day Level", "Risk Multiple", "Fixed Points"], group="Risk Management")
rrRatio = input.float(2.0, "R:R Ratio (if Risk Multiple)", minval=1.0, maxval=5.0, step=0.5, group="Risk Management")
fixedTargetPoints = input.float(40.0, "Fixed Target (points)", minval=10, maxval=200, group="Risk Management")

// Session Filters
avoidLunchLull = input.bool(true, "Avoid Lunch Lull (12:00-12:45)", group="Session Filter")
noTradesAfter1PM = input.bool(true, "No New Trades After 1PM", group="Session Filter")

// SMC Filters
requireFVGConfluence = input.bool(true, "Require FVG + ORB Confluence", group="SMC Filters")
requireBOSConfirmation = input.bool(false, "Require BOS Confirmation", group="SMC Filters")
swingLookback = input.int(5, "Swing Lookback (bars)", minval=3, maxval=20, group="SMC Filters")

// Display
showORB = input.bool(true, "Show ORB Box", group="Display")
showPDLevels = input.bool(true, "Show Previous Day Levels", group="Display")
showLabels = input.bool(true, "Show Breakout Labels", group="Display")
showFVG = input.bool(true, "Show FVGs", group="Display")
showBOSCHoCH = input.bool(true, "Show BOS/CHoCH", group="Display")

// ==================== TIME FUNCTIONS ====================
nyHour = hour(time, "America/New_York")
nyMinute = minute(time, "America/New_York")
nyTime = nyHour * 100 + nyMinute

isNYSession = nyTime >= 930 and nyTime < 1330
isNYRTH = nyTime >= 930 and nyTime < 1600  // Regular Trading Hours for PDH/PDL
isLunchLull = nyTime >= 1200 and nyTime < 1245
isAfter1PM = nyTime >= 1300
is10AMReversal = nyTime >= 1000 and nyTime < 1030

// ORB session based on duration
inORBSession = switch orbMinutes
    5 => nyTime >= 930 and nyTime < 935
    15 => nyTime >= 930 and nyTime < 945
    30 => nyTime >= 930 and nyTime < 1000
    60 => nyTime >= 930 and nyTime < 1030
    => false

newDay = ta.change(time("1D")) != 0

// ==================== ATR ====================
atr = ta.atr(14)

// ==================== FVG DETECTION ====================
// Bullish FVG: gap between candle[2] high and candle[0] low
// Bearish FVG: gap between candle[2] low and candle[0] high
bullishFVG = low > high[2]
bearishFVG = high < low[2]

bullishFVGTop = bullishFVG ? low : na
bullishFVGBottom = bullishFVG ? high[2] : na
bearishFVGTop = bearishFVG ? low[2] : na
bearishFVGBottom = bearishFVG ? high : na

// Track recent FVGs for confluence check
var float recentBullFVGTop = na
var float recentBullFVGBottom = na
var float recentBearFVGTop = na
var float recentBearFVGBottom = na
var int bullFVGBar = na
var int bearFVGBar = na

if bullishFVG
    recentBullFVGTop := bullishFVGTop
    recentBullFVGBottom := bullishFVGBottom
    bullFVGBar := bar_index

if bearishFVG
    recentBearFVGTop := bearishFVGTop
    recentBearFVGBottom := bearishFVGBottom
    bearFVGBar := bar_index

// Reset FVGs on new day
if newDay
    recentBullFVGTop := na
    recentBullFVGBottom := na
    recentBearFVGTop := na
    recentBearFVGBottom := na

// ==================== SWING DETECTION (BOS/CHoCH) ====================
// Find swing highs and lows
swingHigh = ta.pivothigh(high, swingLookback, swingLookback)
swingLow = ta.pivotlow(low, swingLookback, swingLookback)

var float lastSwingHigh = na
var float lastSwingLow = na
var float prevSwingHigh = na
var float prevSwingLow = na

if not na(swingHigh)
    prevSwingHigh := lastSwingHigh
    lastSwingHigh := swingHigh

if not na(swingLow)
    prevSwingLow := lastSwingLow
    lastSwingLow := swingLow

// Determine current trend based on swing structure
var int trend = 0  // 1 = bullish, -1 = bearish, 0 = neutral

// Break of Structure (confirms trend continuation) - only when already in that trend
bosUp = trend == 1 and not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh
bosDown = trend == -1 and not na(lastSwingLow) and close < lastSwingLow and close[1] >= lastSwingLow

// Change of Character (signals potential reversal) - only when breaking against current trend
chochUp = trend <= 0 and not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh
chochDown = trend >= 0 and not na(lastSwingLow) and close < lastSwingLow and close[1] >= lastSwingLow

// Update trend
if bosUp or chochUp
    trend := 1
if bosDown or chochDown
    trend := -1

// ==================== ORB CALCULATION ====================
var float orbHigh = na
var float orbLow = na
var bool orbSet = false
var int orbStartBar = na

if newDay
    orbHigh := na
    orbLow := na
    orbSet := false
    orbStartBar := na

if inORBSession
    if na(orbHigh) or high > orbHigh
        orbHigh := high
    if na(orbLow) or low < orbLow
        orbLow := low
    if na(orbStartBar)
        orbStartBar := bar_index

if not inORBSession and not na(orbHigh) and not na(orbLow) and not orbSet
    orbSet := true

// ==================== PREVIOUS DAY LEVELS ====================
var float pdh = na
var float pdl = na
var float nyRTHHigh = na
var float nyRTHLow = na

// Track high/low during NY RTH session (9:30 AM - 4:00 PM ET)
if isNYRTH
    if na(nyRTHHigh) or high > nyRTHHigh
        nyRTHHigh := high
    if na(nyRTHLow) or low < nyRTHLow
        nyRTHLow := low

// On new day, save previous NY RTH session levels as PDH/PDL
if newDay
    if not na(nyRTHHigh)
        pdh := nyRTHHigh
        pdl := nyRTHLow
    nyRTHHigh := na
    nyRTHLow := na

// ==================== BREAKOUT DETECTION ====================
orbBreakoutUp = orbSet and close > orbHigh and close[1] <= orbHigh
orbBreakoutDown = orbSet and close < orbLow and close[1] >= orbLow

// ==================== FVG + ORB CONFLUENCE ====================
// Check if a bullish FVG overlaps with ORB high level (for long entries)
// FVG should be near the breakout level to provide support on retest
bullFVGOverlapsORB() =>
    not na(recentBullFVGTop) and not na(recentBullFVGBottom) and
     (recentBullFVGTop >= orbHigh or recentBullFVGBottom <= orbHigh) and
     (bar_index - bullFVGBar < 10)  // FVG formed within last 10 bars

// Check if a bearish FVG overlaps with ORB low level (for short entries)
bearFVGOverlapsORB() =>
    not na(recentBearFVGTop) and not na(recentBearFVGBottom) and
     (recentBearFVGTop >= orbLow or recentBearFVGBottom <= orbLow) and
     (bar_index - bearFVGBar < 10)

// FVG confluence flags
hasBullishConfluence = not requireFVGConfluence or bullFVGOverlapsORB()
hasBearishConfluence = not requireFVGConfluence or bearFVGOverlapsORB()

// BOS confirmation flags
hasBullishBOS = not requireBOSConfirmation or trend == 1 or bosUp
hasBearishBOS = not requireBOSConfirmation or trend == -1 or bosDown

// Final breakout signals with SMC filters
orbBreakoutUpConfirmed = orbBreakoutUp and hasBullishConfluence and hasBullishBOS
orbBreakoutDownConfirmed = orbBreakoutDown and hasBearishConfluence and hasBearishBOS

// ==================== TRADING LOGIC ====================
// Can trade check based on session filters
canTrade = isNYSession
if avoidLunchLull and isLunchLull
    canTrade := false
if noTradesAfter1PM and isAfter1PM
    canTrade := false

// Calculate stop and target based on settings
calcLongStop() =>
    switch stopType
        "Opposite ORB Level" => orbLow
        "Fixed Points" => close - fixedStopPoints
        "ATR Based" => close - (atr * atrMultiplier)
        => orbLow

calcShortStop() =>
    switch stopType
        "Opposite ORB Level" => orbHigh
        "Fixed Points" => close + fixedStopPoints
        "ATR Based" => close + (atr * atrMultiplier)
        => orbHigh

calcLongTarget(entryPrice, stopPrice) =>
    switch targetType
        "Previous Day Level" => not na(pdh) and pdh > entryPrice ? pdh : entryPrice + (entryPrice - stopPrice) * rrRatio
        "Risk Multiple" => entryPrice + (entryPrice - stopPrice) * rrRatio
        "Fixed Points" => entryPrice + fixedTargetPoints
        => pdh

calcShortTarget(entryPrice, stopPrice) =>
    switch targetType
        "Previous Day Level" => not na(pdl) and pdl < entryPrice ? pdl : entryPrice - (stopPrice - entryPrice) * rrRatio
        "Risk Multiple" => entryPrice - (stopPrice - entryPrice) * rrRatio
        "Fixed Points" => entryPrice - fixedTargetPoints
        => pdl

// Position sizing based on risk (MNQ = $2 per point per contract)
pointValue = 2.0  // MNQ point value
calcQty(stopDistance) =>
    riskInPoints = math.abs(stopDistance)
    riskPerContract = riskInPoints * pointValue
    qty = riskPerContract > 0 ? math.floor(riskPerTrade / riskPerContract) : 1
    math.max(qty, 1)

// ==================== EXECUTE TRADES ====================
if orbBreakoutUpConfirmed and canTrade and strategy.position_size == 0
    entryPrice = close
    stopPrice = calcLongStop()
    targetPrice = calcLongTarget(entryPrice, stopPrice)
    qty = calcQty(entryPrice - stopPrice)

    strategy.entry("Long ORB", strategy.long, qty=qty)
    strategy.exit("Long Exit", "Long ORB", stop=stopPrice, limit=targetPrice)

if orbBreakoutDownConfirmed and canTrade and strategy.position_size == 0
    entryPrice = close
    stopPrice = calcShortStop()
    targetPrice = calcShortTarget(entryPrice, stopPrice)
    qty = calcQty(stopPrice - entryPrice)

    strategy.entry("Short ORB", strategy.short, qty=qty)
    strategy.exit("Short Exit", "Short ORB", stop=stopPrice, limit=targetPrice)

// ==================== VISUALS ====================
// ORB Box
var box orbBox = na
var line orbHighLine = na
var line orbLowLine = na

if newDay
    box.delete(orbBox)
    line.delete(orbHighLine)
    line.delete(orbLowLine)

if orbSet and showORB and na(orbBox)
    orbBox := box.new(orbStartBar, orbHigh, bar_index + 50, orbLow,
         border_color=color.new(color.blue, 50), bgcolor=color.new(color.blue, 90))
    orbHighLine := line.new(orbStartBar, orbHigh, bar_index + 100, orbHigh,
         color=color.new(color.blue, 30), style=line.style_solid, width=2)
    orbLowLine := line.new(orbStartBar, orbLow, bar_index + 100, orbLow,
         color=color.new(color.blue, 30), style=line.style_solid, width=2)

// Breakout labels (show confirmed entries)
if orbBreakoutUpConfirmed and showLabels
    label.new(bar_index, low, "ORB\nBREAK", color=color.green, textcolor=color.white,
         style=label.style_label_up, size=size.large)

if orbBreakoutDownConfirmed and showLabels
    label.new(bar_index, high, "ORB\nBREAK", color=color.red, textcolor=color.white,
         style=label.style_label_down, size=size.large)

// Ignored breakout labels (when breakout occurs but SMC filters reject it)
if orbBreakoutUp and not orbBreakoutUpConfirmed and showLabels
    label.new(bar_index, low, "ORB\n(Ignored)", color=color.new(color.green, 70), textcolor=color.white,
         style=label.style_label_up, size=size.normal)

if orbBreakoutDown and not orbBreakoutDownConfirmed and showLabels
    label.new(bar_index, high, "ORB\n(Ignored)", color=color.new(color.red, 70), textcolor=color.white,
         style=label.style_label_down, size=size.normal)

// Previous day levels
var line pdhLine = na
var line pdlLine = na
var label pdhLabel = na
var label pdlLabel = na

if newDay and showPDLevels
    line.delete(pdhLine)
    line.delete(pdlLine)
    label.delete(pdhLabel)
    label.delete(pdlLabel)

    if not na(pdh)
        pdhLine := line.new(bar_index, pdh, bar_index + 1, pdh, extend=extend.right,
             color=color.new(color.red, 30), style=line.style_dashed, width=2)
        pdhLabel := label.new(bar_index, pdh, "PDH", color=color.new(color.white, 100),
             textcolor=color.red, style=label.style_label_left, size=size.large)

    if not na(pdl)
        pdlLine := line.new(bar_index, pdl, bar_index + 1, pdl, extend=extend.right,
             color=color.new(color.green, 30), style=line.style_dashed, width=2)
        pdlLabel := label.new(bar_index, pdl, "PDL", color=color.new(color.white, 100),
             textcolor=color.green, style=label.style_label_left, size=size.large)

// Session background highlights
bgcolor(isNYSession and not isLunchLull ? color.new(color.green, 95) : na, title="NY Session")
bgcolor(isLunchLull ? color.new(color.red, 95) : na, title="Lunch Lull")
bgcolor(is10AMReversal ? color.new(color.orange, 95) : na, title="10AM Reversal Window")

// ==================== FVG VISUALS ====================
if bullishFVG and showFVG and isNYSession
    box.new(bar_index - 2, bullishFVGTop, bar_index, bullishFVGBottom,
         border_color=color.new(color.teal, 60), bgcolor=color.new(color.teal, 85))

if bearishFVG and showFVG and isNYSession
    box.new(bar_index - 2, bearishFVGTop, bar_index, bearishFVGBottom,
         border_color=color.new(color.purple, 60), bgcolor=color.new(color.purple, 85))

// ==================== BOS / CHoCH VISUALS ====================
if bosUp and showBOSCHoCH
    label.new(bar_index, high, "BOS", color=color.new(color.green, 50), textcolor=color.white,
         style=label.style_label_down, size=size.normal)

if bosDown and showBOSCHoCH
    label.new(bar_index, low, "BOS", color=color.new(color.red, 50), textcolor=color.white,
         style=label.style_label_up, size=size.normal)

if chochUp and showBOSCHoCH
    label.new(bar_index, high, "CHoCH", color=color.new(color.lime, 30), textcolor=color.black,
         style=label.style_label_down, size=size.large)

if chochDown and showBOSCHoCH
    label.new(bar_index, low, "CHoCH", color=color.new(color.fuchsia, 30), textcolor=color.white,
         style=label.style_label_up, size=size.large)
